<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"brainku.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="前言之前对这个函数功能不是太了解，在阅读《Android开发精要》这本书的过程中发现关于这个函数的描述存在矛盾。这个在Activity的生命周期中可能涉及到的函数做了什么，又是怎么做的，又有什么需要注意的，不弄懂的话说不过去~">
<meta property="og:type" content="article">
<meta property="og:title" content="关于onSaveInstanceState的那点事">
<meta property="og:url" content="https://brainku.github.io/2014/10/07/something-about-onsaveinstancestate/index.html">
<meta property="og:site_name" content="Self Driven">
<meta property="og:description" content="前言之前对这个函数功能不是太了解，在阅读《Android开发精要》这本书的过程中发现关于这个函数的描述存在矛盾。这个在Activity的生命周期中可能涉及到的函数做了什么，又是怎么做的，又有什么需要注意的，不弄懂的话说不过去~">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2014-10-07T11:52:21.000Z">
<meta property="article:modified_time" content="2017-05-09T23:38:51.000Z">
<meta property="article:author" content="苦辛味">
<meta property="article:tag" content="android">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="持久化">
<meta property="article:tag" content="问题">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://brainku.github.io/2014/10/07/something-about-onsaveinstancestate/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>关于onSaveInstanceState的那点事 | Self Driven</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Self Driven</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">兴趣是1，坚持是剩下的99</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://brainku.github.io/2014/10/07/something-about-onsaveinstancestate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="苦辛味">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Self Driven">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          关于onSaveInstanceState的那点事
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2014-10-07 19:52:21" itemprop="dateCreated datePublished" datetime="2014-10-07T19:52:21+08:00">2014-10-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2017-05-10 07:38:51" itemprop="dateModified" datetime="2017-05-10T07:38:51+08:00">2017-05-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index"><span itemprop="name">android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>之前对这个函数功能不是太了解，在<a href="https://brainku.github.io/2014/10/01/reading-android-develop-master/">阅读《Android开发精要》</a>这本书的过程中发现关于这个函数的描述存在矛盾。这个在Activity的生命周期中可能涉及到的函数做了什么，又是怎么做的，又有什么需要注意的，不弄懂的话说不过去~</p>
<span id="more"></span>

<h2 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h2><h3 id="做了什么"><a href="#做了什么" class="headerlink" title="做了什么"></a>做了什么</h3><p>默认的情况下是怎么做的,先来看下官方的文档：</p>
<blockquote>
<p>默认实现是调用<code>View.onSaveInstanceState()</code>将大部分有指定id的View状态保存下来，如果存在focusedView也会保存对应的id信息。这些设置的信息都会在<code>onRestoreInstanceState()</code>的默认实现中恢复。如果你重写了这个方法来保存没被View保存的信息，记得调用<code>super</code>来调用默认实现，否则做好自己手动保存所有View状态的准备~(<strong>注：</strong>默认View是什么都不保存的，继承View的控件自己保存需要的内容</p>
</blockquote>
<p>官方是如此说明的，那么就跟踪一下代码如何？</p>
<h3 id="怎么做的"><a href="#怎么做的" class="headerlink" title="怎么做的"></a>怎么做的</h3><p>从Activity开始：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android/app/Activity.class</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle outState)</span> &#123;</span><br><span class="line">  <span class="comment">// 调用了Window保存层次信息，Window是一个抽象类，实现类是PhoneWindow</span></span><br><span class="line">  outState.putBundle(WINDOW_HIERARCHY_TAG,mWindow.saveHierarchyState());</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看看在Window的实现类里面做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com/android/internal/policy/impl/PhoneWindow.java</span></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> Bundle <span class="title function_">saveHierarchyState</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Bundle</span> <span class="variable">outState</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">	<span class="comment">// 如果没有设置mContentParent,即它为null，则不需要保存任何信息直接返回</span></span><br><span class="line">	<span class="comment">// mContentParent为空的情况也就是没有调用installDecor的情况</span></span><br><span class="line">	<span class="comment">// 也即没有发生任何获取窗口的View以及设置添加View的行为,如setContentView</span></span><br><span class="line">        <span class="keyword">if</span> (mContentParent == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> outState;</span><br><span class="line">        &#125;</span><br><span class="line">        SparseArray&lt;Parcelable&gt; states = <span class="keyword">new</span> <span class="title class_">SparseArray</span>&lt;Parcelable&gt;();</span><br><span class="line">	<span class="comment">// 保存整个ViewGroup的层次信息</span></span><br><span class="line">        mContentParent.saveHierarchyState(states);</span><br><span class="line">        outState.putSparseParcelableArray(VIEWS_TAG, states);</span><br><span class="line">	<span class="comment">// 保存当前ViewGroup的focusedView</span></span><br><span class="line">        <span class="comment">// save the focused view id</span></span><br><span class="line">        <span class="type">View</span> <span class="variable">focusedView</span> <span class="operator">=</span> mContentParent.findFocus();</span><br><span class="line">        <span class="keyword">if</span> (focusedView != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (focusedView.getId() != View.NO_ID) &#123;</span><br><span class="line">                outState.putInt(FOCUSED_ID_TAG, focusedView.getId());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		...<span class="comment">// log something</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	... <span class="comment">// save the panels</span></span><br><span class="line">	... <span class="comment">// save ActionBar state</span></span><br><span class="line">        <span class="keyword">return</span> outState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了<code>mContentParent.saveHierarchyState(states)</code>来保存整个ViewGroup的状态信息,其中<code>mContentParent = generateLayout(mDecor);</code>。如果有了解过Window的界面布局的话，会知道mContentParent其实也就是我们<code>setContentView()</code>时添加的布局。<br>再看看<code>mContentParent</code>做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android/view.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveHierarchyState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> &#123;</span><br><span class="line">      dispatchSaveInstanceState(container);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> &#123;</span><br><span class="line">	<span class="comment">// 只有存在ID且允许保存状态的View才会被保存状态，否则忽略</span></span><br><span class="line">        <span class="keyword">if</span> (mID != NO_ID &amp;&amp; (mViewFlags &amp; SAVE_DISABLED_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">            mPrivateFlags &amp;= ~PFLAG_SAVE_STATE_CALLED;</span><br><span class="line">            <span class="type">Parcelable</span> <span class="variable">state</span> <span class="operator">=</span> onSaveInstanceState();</span><br><span class="line">	<span class="comment">// 继承类，如果没有调用super来保存父类的信息那么就抛出异常</span></span><br><span class="line">    	<span class="comment">// 这里有点小技巧，通过与操作取得了该设置位的信息</span></span><br><span class="line">            <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_SAVE_STATE_CALLED) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;Derived class did not call super.onSaveInstanceState()&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (state != <span class="literal">null</span>) &#123;</span><br><span class="line">                container.put(mID, state);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mContentParent调用的<code>saveHierarchyState()</code>实际是View中实现的方法，而在ViewGroup只是重写了<code>dispatchSaveInstanceState()</code>这个方法来分发保存状态的事件到ChildView：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android/ViewGroup.class</span></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">dispatchSaveInstanceState</span><span class="params">(SparseArray&lt;Parcelable&gt; container)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.dispatchSaveInstanceState(container);</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> mChildrenCount;</span><br><span class="line">    <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="type">View</span> <span class="variable">c</span> <span class="operator">=</span> children[i];</span><br><span class="line">        <span class="comment">// 如果ViewGroup没有设置不需要保存状态才保存ChildView</span></span><br><span class="line">        <span class="keyword">if</span> ((c.mViewFlags &amp; PARENT_SAVE_DISABLED_MASK) != PARENT_SAVE_DISABLED) &#123;</span><br><span class="line">            c.dispatchSaveInstanceState(container);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基本过程就是这样子，简单地总结下它怎么做的话就是<br><em><strong>onSaveInstanceState默认将调用当前Window中有id且有需要的View的onSaveInstanceState方法来保存它们自己所需要的信息</strong></em>（其实还会有保存fragment信息的过程，在这篇博客中暂不讨论~）</p>
<h3 id="存在哪里"><a href="#存在哪里" class="headerlink" title="存在哪里"></a>存在哪里</h3><p>做完上面那堆事之后，留有所有信息的那个outState又存到哪去了？<br>具体存储的过程可以在ActivityThread的源码中看到，它将这个bundle（也就是savedInstanceState）存储在了ActivityClientRecord这个类的实例中。<br>在《Android Programming》中提到的内容<strong>基本</strong>可信，因此这里不再跟踪源码。</p>
<blockquote>
<p>The bundle is then stuffed(被塞进）into your activity’s activity record by OS.</p>
</blockquote>
<p>那么这个record什么时候会被销毁？<br>如果你按下了返回键，那么Activity就被销毁了，对应的ActivityRecord也不复存在。另外在机器重启，或者这个Activity长期没再使用时，这个record也会被销毁。</p>
<h3 id="什么时候"><a href="#什么时候" class="headerlink" title="什么时候"></a>什么时候</h3><p>那么它又在什么时候调用的咧,看下API说明：</p>
<blockquote>
<p>为了能够在重新创建的某个时间点上来恢复它的状态，这个方法会在一个Activity可能被销毁前被调用。<br>不要跟Activity的生命周期如<code>onPause()</code>之类的回调中搞混。考虑下面三个场景</p>
<ol>
<li>onPause和onStop都被调用，但这个方法没被调用：从Activity B返回A，此时不会调用B的onSaveInstanceState方法，因为B不需要被恢复。</li>
<li>onPause被调用，但是onSaveInstanceState不被调用的情况：当B在A之后被创建，如果在B的生存期间A并没有被销毁的话，那么系统可能并不会调用A的onSaveInstanceState方法，因为这个时候的A仍然是完整的。</li>
</ol>
<p>如果这个方法会被调用，那么只能保证它会在onStop之前调用，无法保证它是在onPause之前还是之后被调用。</p>
</blockquote>
<p>在之前看过的资料中，《Android开发精要》中对于onSaveInstanceState的调用时机说明是有误的，它将这个方法的调用时间放在了<code>onPause()</code>之前。而按照上面的doc的说法，这个方法是否会被调用也还要看情况的，所以并不能依靠这个方法来保存数据。【实际在验证之后发现，在跳转的过程中该方法是一定会调用的，并未出现不调用的情况】</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>在Activity的各个生命周期以及<code>onSaveInstanceState()</code>，<code>onRestoreInstanceState()</code>打log。验证一下在下面几种情况中，调用顺序的问题：</p>
<h3 id="旋转导致重建"><a href="#旋转导致重建" class="headerlink" title="旋转导致重建"></a>旋转导致重建</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rotation 4.4 以下均忽略一开始的onCreate到onResume</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.502</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onPause</span><span class="params">()</span>             <span class="comment">// 发生旋转</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.502</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onSaveInstanceState</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.502</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onStop</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.738</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onCreate</span><span class="params">()</span>            <span class="comment">// 重新创建</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.742</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onStart</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.758</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onRestorInstanceState</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">50</span>:<span class="number">16.758</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onResume</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Rotation 2.3.7</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">08.890</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onSaveInstanceState</span><span class="params">()</span> <span class="comment">// 发生旋转</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">08.900</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onPause</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">08.910</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onStop</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">08.980</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onCreate</span><span class="params">()</span>            <span class="comment">// 重新创建</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">09.010</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onStart</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">09.020</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onRestorInstanceState</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">09.030</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onResume</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<p>在查看ActivityThread源码的时候发现几句注释：</p>
<blockquote>
<p>We need to keep around the original state, in case we need to be created again.  But we only do this for pre-Honeycomb apps, which always save their state when pausing, so we can not have them save their state when restarting from a paused state.  For HC and later, we want to (and can) let the state be saved as the normal part of stopping the activity.</p>
</blockquote>
<p>在3.0之前，<code>onSaveInstanceState()</code>是<code>onPause()</code>的一部分，而在HC之后，则变成了<code>onStop()</code>的一部分。</p>
<h3 id="跳转恢复"><a href="#跳转恢复" class="headerlink" title="跳转恢复"></a>跳转恢复</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4.4</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">51</span>:<span class="number">49.253</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onPause</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">51</span>:<span class="number">50.321</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onSaveInstanceState</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">51</span>:<span class="number">50.321</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onStop</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">53</span>:<span class="number">12.772</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onStart</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">18</span>:<span class="number">53</span>:<span class="number">12.776</span>: D/Saved(<span class="number">1975</span>): call <span class="title function_">onResume</span><span class="params">()</span></span><br><span class="line"><span class="comment">// 2.3.7</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">55.680</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onSaveInstanceState</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">55.680</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onPause</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">15</span>:<span class="number">56.380</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onStop</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">23.380</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onStart</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">23.380</span>: D/Saved(<span class="number">1480</span>): call <span class="title function_">onResume</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<p>根据上面的log记录可以发现，就跟旋转导致重建的过程一样，因为同样的原因<code>onSaveInstancteState()</code>被提前了。</p>
<h3 id="按返回键退出"><a href="#按返回键退出" class="headerlink" title="按返回键退出"></a>按返回键退出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">37</span>:<span class="number">03.100</span>: D/Saved(<span class="number">1588</span>): call <span class="title function_">onPause</span><span class="params">()</span></span><br><span class="line"><span class="number">10</span>-<span class="number">22</span> <span class="number">11</span>:<span class="number">37</span>:<span class="number">03.980</span>: D/Saved(<span class="number">1588</span>): call <span class="title function_">onStop</span><span class="params">()</span></span><br></pre></td></tr></table></figure>
<p>无论是否根Activity，都只会调用Activity的生命周期回调，而不会保存任何状态信息。再点开应用之后，也就无法恢复之前<code>onSaveInstanceState()</code>保存的数据。</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="关于View的id"><a href="#关于View的id" class="headerlink" title="关于View的id"></a>关于View的id</h3><p>其实从mContentParent分发保存状态事件的过程中就可以发现，默认是使用ID来作为SparseArray的key的，那么就会存在无法保存状态或者状态异常的情况。</p>
<ol>
<li>没有设置ID</li>
<li>设置了同名id</li>
</ol>
<p>第一种情况基本不是问题，因为对于重要的控件一般都会设置一个id，但第二种情况就会比较麻烦了。设置同名id会导致后面出现的控件覆盖前面同名控件所保存的信息，而且还不会有任何警告。在查资料的过程中就发现了这样子的一个<a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoweiz/p/3813914.html">例子</a>。</p>
<h3 id="onRestoreInstanceState"><a href="#onRestoreInstanceState" class="headerlink" title="onRestoreInstanceState"></a>onRestoreInstanceState</h3><p>这是跟<code>onSaveInstanceState</code>对应的方法，对应的实现过程就不再做分析（过程跟保存时的顺序相反），只谈谈这个方法调用的时机。<br>其实从上面验证的过程中就可以知道，<code>onRestoreInstanceState()</code>这个方法只在旋转重建的时候才被调用，在其他情况中均没有被调用。看下doc说明：</p>
<blockquote>
<p>这个方法在Activity在从之前保存的信息中（即savedInstanceState）重新恢复状态的时候，即在<code>onStart()</code>之后被调用。大多数实现会在onCreate中恢复它们的状态，但它有时候也很方便去做，当所有的初始化已经完成完成同时让子类去决定是否使用它们的默认实现。这个方法的默认实现会view恢复到之前被<code>onSaveInstanceState()</code>保存时的状态。<br>This method is called after onStart when the activity is being re-initialized from a previously saved state, given here in savedInstanceState. <strong>Most implementations will simply use onCreate to restore their state, but it is sometimes convenient to do it here after all of the initialization has been done or to allow subclasses to decide whether to use your default implementation.</strong> </p>
</blockquote>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>在验证<code>onSaveInstanceState()</code>调用时机时，发现设置了<code>android:configChanges=&quot;orientation&quot;</code>之后，Activity的任何周期回调均没有调用，但是屏幕中的画面却还是被旋转了，为什么？</li>
<li>在验证的时候发现，即使没有调用<code>onRestoreInstanceState()</code>也可以恢复view的信息，那为什么还会需要这个方法？为什么只在configChanges的时候才调用？</li>
</ul>
<h2 id="勘误"><a href="#勘误" class="headerlink" title="勘误"></a>勘误</h2><blockquote>
<p>以下勘误都仅限Android Programming这本书</p>
</blockquote>
<p>P80, 在*’Saving Data Across Rotation’*这一节中，提到的onSaveInstanceState的默认实现有误，不是所有的views，而是有id的view。另外它还提到能放在SaveInstanceState里面的只能是基本类型和实现了Serializable接口的类，但明显实现Parcelable也是可以的，或者说更推荐后面这种方式。</p>
<h2 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h2><p><a target="_blank" rel="noopener" href="http://www.cnblogs.com/xiaoweiz/p/3813914.html">同ID导致ScrollView位置信息被覆盖</a><br>《Android Programming: The Big Nerd Ranch Guide》 </p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/android/" rel="tag"># android</a>
              <a href="/tags/%E6%BA%90%E7%A0%81/" rel="tag"># 源码</a>
              <a href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/" rel="tag"># 持久化</a>
              <a href="/tags/%E9%97%AE%E9%A2%98/" rel="tag"># 问题</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2014/10/01/reading-android-develop-master/" rel="prev" title="小探Android应用层原理--《Android开发精要》">
      <i class="fa fa-chevron-left"></i> 小探Android应用层原理--《Android开发精要》
    </a></div>
      <div class="post-nav-item">
    <a href="/2014/10/14/learn-python-in-a-quick-way/" rel="next" title="Python的快速入门--《A Byte of Python》">
      Python的快速入门--《A Byte of Python》 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AD%A3%E6%96%87"><span class="nav-number">2.</span> <span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="nav-number">2.1.</span> <span class="nav-text">做了什么</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%8E%E4%B9%88%E5%81%9A%E7%9A%84"><span class="nav-number">2.2.</span> <span class="nav-text">怎么做的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%9C%A8%E5%93%AA%E9%87%8C"><span class="nav-number">2.3.</span> <span class="nav-text">存在哪里</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99"><span class="nav-number">2.4.</span> <span class="nav-text">什么时候</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81"><span class="nav-number">3.</span> <span class="nav-text">验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%8B%E8%BD%AC%E5%AF%BC%E8%87%B4%E9%87%8D%E5%BB%BA"><span class="nav-number">3.1.</span> <span class="nav-text">旋转导致重建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%B3%E8%BD%AC%E6%81%A2%E5%A4%8D"><span class="nav-number">3.2.</span> <span class="nav-text">跳转恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%89%E8%BF%94%E5%9B%9E%E9%94%AE%E9%80%80%E5%87%BA"><span class="nav-number">3.3.</span> <span class="nav-text">按返回键退出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A1%A5%E5%85%85"><span class="nav-number">4.</span> <span class="nav-text">补充</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8EView%E7%9A%84id"><span class="nav-number">4.1.</span> <span class="nav-text">关于View的id</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#onRestoreInstanceState"><span class="nav-number">4.2.</span> <span class="nav-text">onRestoreInstanceState</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98"><span class="nav-number">5.</span> <span class="nav-text">问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8B%98%E8%AF%AF"><span class="nav-number">6.</span> <span class="nav-text">勘误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B5%84%E6%96%99"><span class="nav-number">7.</span> <span class="nav-text">资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">苦辛味</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苦辛味</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
